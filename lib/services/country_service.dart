import 'dart:convert';
import 'package:http/http.dart' as http;

class CountryService {
  static Future<List<Map<String, String>>> fetchCountries() async {
    try {
      // Using REST Countries API - free and reliable
      final response = await http.get(
        Uri.parse('https://restcountries.com/v3.1/all?fields=name,idd,flags'),
      );

      if (response.statusCode == 200) {
        final List<dynamic> data = jsonDecode(response.body);
        
        List<Map<String, String>> countries = [];
        
        // Create a map of country codes to emoji flags
        final Map<String, String> countryCodeToEmoji = {
          '+1': 'ğŸ‡ºğŸ‡¸', '+7': 'ğŸ‡·ğŸ‡º', '+20': 'ğŸ‡ªğŸ‡¬', '+27': 'ğŸ‡¿ğŸ‡¦', '+30': 'ğŸ‡¬ğŸ‡·', '+31': 'ğŸ‡³ğŸ‡±', '+32': 'ğŸ‡§ğŸ‡ª', '+33': 'ğŸ‡«ğŸ‡·', '+34': 'ğŸ‡ªğŸ‡¸', '+36': 'ğŸ‡­ğŸ‡º', '+39': 'ğŸ‡®ğŸ‡¹', '+40': 'ğŸ‡·ğŸ‡´', '+41': 'ğŸ‡¨ğŸ‡­', '+43': 'ğŸ‡¦ğŸ‡¹', '+44': 'ğŸ‡¬ğŸ‡§', '+45': 'ğŸ‡©ğŸ‡°', '+46': 'ğŸ‡¸ğŸ‡ª', '+47': 'ğŸ‡³ğŸ‡´', '+48': 'ğŸ‡µğŸ‡±', '+49': 'ğŸ‡©ğŸ‡ª', '+51': 'ğŸ‡µğŸ‡ª', '+52': 'ğŸ‡²ğŸ‡½', '+53': 'ğŸ‡¨ğŸ‡º', '+54': 'ğŸ‡¦ğŸ‡·', '+55': 'ğŸ‡§ğŸ‡·', '+56': 'ğŸ‡¨ğŸ‡±', '+57': 'ğŸ‡¨ğŸ‡´', '+58': 'ğŸ‡»ğŸ‡ª', '+60': 'ğŸ‡²ğŸ‡¾', '+61': 'ğŸ‡¦ğŸ‡º', '+62': 'ğŸ‡®ğŸ‡©', '+63': 'ğŸ‡µğŸ‡­', '+64': 'ğŸ‡³ğŸ‡¿', '+65': 'ğŸ‡¸ğŸ‡¬', '+66': 'ğŸ‡¹ğŸ‡­', '+81': 'ğŸ‡¯ğŸ‡µ', '+82': 'ğŸ‡°ğŸ‡·', '+84': 'ğŸ‡»ğŸ‡³', '+86': 'ğŸ‡¨ğŸ‡³', '+90': 'ğŸ‡¹ğŸ‡·', '+91': 'ğŸ‡®ğŸ‡³', '+92': 'ğŸ‡µğŸ‡°', '+93': 'ğŸ‡¦ğŸ‡«', '+94': 'ğŸ‡±ğŸ‡°', '+95': 'ğŸ‡²ğŸ‡²', '+98': 'ğŸ‡®ğŸ‡·', '+212': 'ğŸ‡²ğŸ‡¦', '+213': 'ğŸ‡©ğŸ‡¿', '+216': 'ğŸ‡¹ğŸ‡³', '+218': 'ğŸ‡±ğŸ‡¾', '+220': 'ğŸ‡¬ğŸ‡²', '+221': 'ğŸ‡¸ğŸ‡³', '+222': 'ğŸ‡²ğŸ‡·', '+223': 'ğŸ‡²ğŸ‡±', '+224': 'ğŸ‡¬ğŸ‡³', '+225': 'ğŸ‡¨ğŸ‡®', '+226': 'ğŸ‡§ğŸ‡«', '+227': 'ğŸ‡³ğŸ‡ª', '+228': 'ğŸ‡¹ğŸ‡¬', '+229': 'ğŸ‡§ğŸ‡¯', '+230': 'ğŸ‡²ğŸ‡º', '+231': 'ğŸ‡±ğŸ‡·', '+232': 'ğŸ‡¸ğŸ‡±', '+233': 'ğŸ‡¬ğŸ‡­', '+234': 'ğŸ‡³ğŸ‡¬', '+235': 'ğŸ‡¹ğŸ‡©', '+236': 'ğŸ‡¨ğŸ‡«', '+237': 'ğŸ‡¨ğŸ‡²', '+238': 'ğŸ‡¨ğŸ‡»', '+239': 'ğŸ‡¸ğŸ‡¹', '+240': 'ğŸ‡¬ğŸ‡¶', '+241': 'ğŸ‡¬ğŸ‡¦', '+242': 'ğŸ‡¨ğŸ‡¬', '+243': 'ğŸ‡¨ğŸ‡©', '+244': 'ğŸ‡¦ğŸ‡´', '+245': 'ğŸ‡¬ğŸ‡¼', '+246': 'ğŸ‡©ğŸ‡¬', '+248': 'ğŸ‡¸ğŸ‡¨', '+249': 'ğŸ‡¸ğŸ‡©', '+250': 'ğŸ‡·ğŸ‡¼', '+251': 'ğŸ‡ªğŸ‡¹', '+252': 'ğŸ‡¸ğŸ‡´', '+253': 'ğŸ‡©ğŸ‡¯', '+254': 'ğŸ‡°ğŸ‡ª', '+255': 'ğŸ‡¹ğŸ‡¿', '+256': 'ğŸ‡ºğŸ‡¬', '+257': 'ğŸ‡§ğŸ‡®', '+258': 'ğŸ‡²ğŸ‡¿', '+260': 'ğŸ‡¿ğŸ‡²', '+261': 'ğŸ‡²ğŸ‡¬', '+262': 'ğŸ‡·ğŸ‡ª', '+263': 'ğŸ‡¿ğŸ‡¼', '+264': 'ğŸ‡³ğŸ‡¦', '+265': 'ğŸ‡²ğŸ‡¼', '+266': 'ğŸ‡±ğŸ‡¸', '+267': 'ğŸ‡§ğŸ‡¼', '+268': 'ğŸ‡¸ğŸ‡¿', '+290': 'ğŸ‡¸ğŸ‡­', '+291': 'ğŸ‡ªğŸ‡·', '+297': 'ğŸ‡¦ğŸ‡¼', '+298': 'ğŸ‡«ğŸ‡´', '+299': 'ğŸ‡¬ğŸ‡±', '+350': 'ğŸ‡¬ğŸ‡®', '+351': 'ğŸ‡µğŸ‡¹', '+352': 'ğŸ‡±ğŸ‡º', '+353': 'ğŸ‡®ğŸ‡ª', '+354': 'ğŸ‡®ğŸ‡¸', '+355': 'ğŸ‡¦ğŸ‡±', '+356': 'ğŸ‡²ğŸ‡¹', '+357': 'ğŸ‡¨ğŸ‡¾', '+358': 'ğŸ‡«ğŸ‡®', '+359': 'ğŸ‡§ğŸ‡¬', '+370': 'ğŸ‡±ğŸ‡¹', '+371': 'ğŸ‡±ğŸ‡»', '+372': 'ğŸ‡ªğŸ‡ª', '+373': 'ğŸ‡²ğŸ‡©', '+374': 'ğŸ‡¦ğŸ‡²', '+375': 'ğŸ‡§ğŸ‡¾', '+376': 'ğŸ‡¦ğŸ‡©', '+377': 'ğŸ‡²ğŸ‡¨', '+378': 'ğŸ‡¸ğŸ‡²', '+380': 'ğŸ‡ºğŸ‡¦', '+381': 'ğŸ‡·ğŸ‡¸', '+382': 'ğŸ‡²ğŸ‡ª', '+383': 'ğŸ‡½ğŸ‡°', '+385': 'ğŸ‡­ğŸ‡·', '+386': 'ğŸ‡¸ğŸ‡®', '+387': 'ğŸ‡§ğŸ‡¦', '+389': 'ğŸ‡²ğŸ‡°', '+420': 'ğŸ‡¨ğŸ‡¿', '+421': 'ğŸ‡¸ğŸ‡°', '+423': 'ğŸ‡±ğŸ‡®', '+500': 'ğŸ‡«ğŸ‡°', '+501': 'ğŸ‡§ğŸ‡¿', '+502': 'ğŸ‡¬ğŸ‡¹', '+503': 'ğŸ‡¸ğŸ‡»', '+504': 'ğŸ‡­ğŸ‡³', '+505': 'ğŸ‡³ğŸ‡®', '+506': 'ğŸ‡¨ğŸ‡·', '+507': 'ğŸ‡µğŸ‡¦', '+508': 'ğŸ‡µğŸ‡²', '+509': 'ğŸ‡­ğŸ‡¹', '+590': 'ğŸ‡¬ğŸ‡µ', '+591': 'ğŸ‡§ğŸ‡´', '+592': 'ğŸ‡¬ğŸ‡¾', '+593': 'ğŸ‡ªğŸ‡¨', '+594': 'ğŸ‡¬ğŸ‡«', '+595': 'ğŸ‡µğŸ‡¾', '+596': 'ğŸ‡²ğŸ‡¶', '+597': 'ğŸ‡¸ğŸ‡·', '+598': 'ğŸ‡ºğŸ‡¾', '+599': 'ğŸ‡¨ğŸ‡¼', '+670': 'ğŸ‡¹ğŸ‡±', '+672': 'ğŸ‡³ğŸ‡«', '+673': 'ğŸ‡§ğŸ‡³', '+674': 'ğŸ‡³ğŸ‡·', '+675': 'ğŸ‡µğŸ‡¬', '+676': 'ğŸ‡¹ğŸ‡´', '+677': 'ğŸ‡¸ğŸ‡§', '+678': 'ğŸ‡»ğŸ‡º', '+679': 'ğŸ‡«ğŸ‡¯', '+680': 'ğŸ‡µğŸ‡¼', '+681': 'ğŸ‡¼ğŸ‡«', '+682': 'ğŸ‡¨ğŸ‡°', '+683': 'ğŸ‡³ğŸ‡º', '+684': 'ğŸ‡¦ğŸ‡¸', '+685': 'ğŸ‡¼ğŸ‡¸', '+686': 'ğŸ‡°ğŸ‡®', '+687': 'ğŸ‡³ğŸ‡¨', '+688': 'ğŸ‡¹ğŸ‡»', '+689': 'ğŸ‡µğŸ‡«', '+690': 'ğŸ‡¹ğŸ‡°', '+691': 'ğŸ‡«ğŸ‡²', '+692': 'ğŸ‡²ğŸ‡­', '+800': 'ğŸ³ï¸', '+808': 'ğŸ³ï¸', '+850': 'ğŸ‡°ğŸ‡µ', '+852': 'ğŸ‡­ğŸ‡°', '+853': 'ğŸ‡²ğŸ‡´', '+855': 'ğŸ‡°ğŸ‡­', '+856': 'ğŸ‡±ğŸ‡¦', '+870': 'ğŸ³ï¸', '+878': 'ğŸ³ï¸', '+880': 'ğŸ‡§ğŸ‡©', '+881': 'ğŸ³ï¸', '+882': 'ğŸ³ï¸', '+883': 'ğŸ³ï¸', '+886': 'ğŸ‡¹ğŸ‡¼', '+888': 'ğŸ³ï¸', '+960': 'ğŸ‡²ğŸ‡»', '+961': 'ğŸ‡±ğŸ‡§', '+962': 'ğŸ‡¯ğŸ‡´', '+963': 'ğŸ‡¸ğŸ‡¾', '+964': 'ğŸ‡®ğŸ‡¶', '+965': 'ğŸ‡°ğŸ‡¼', '+966': 'ğŸ‡¸ğŸ‡¦', '+967': 'ğŸ‡¾ğŸ‡ª', '+968': 'ğŸ‡´ğŸ‡²', '+970': 'ğŸ‡µğŸ‡¸', '+971': 'ğŸ‡¦ğŸ‡ª', '+972': 'ğŸ‡®ğŸ‡±', '+973': 'ğŸ‡§ğŸ‡­', '+974': 'ğŸ‡¶ğŸ‡¦', '+975': 'ğŸ‡§ğŸ‡¹', '+976': 'ğŸ‡²ğŸ‡³', '+977': 'ğŸ‡³ğŸ‡µ', '+979': 'ğŸ³ï¸', '+992': 'ğŸ‡¹ğŸ‡¯', '+993': 'ğŸ‡¹ğŸ‡²', '+994': 'ğŸ‡¦ğŸ‡¿', '+995': 'ğŸ‡¬ğŸ‡ª', '+996': 'ğŸ‡°ğŸ‡¬', '+998': 'ğŸ‡ºğŸ‡¿'
        };
        
        for (var country in data) {
          final name = country['name']['common'] as String;
          final idd = country['idd'] as Map<String, dynamic>?;
          
          if (idd != null && idd['root'] != null) {
            String root = idd['root'] as String;
            List<dynamic> suffixes = idd['suffixes'] ?? [''];
            
            for (var suffix in suffixes) {
              String countryCode = root + suffix.toString();
              
              // Filter out invalid codes and prioritize common ones
              if (countryCode.length >= 2 && countryCode.length <= 4 && 
                  !countryCode.contains(' ') && 
                  !countryCode.contains('-')) {
                
                // Get emoji flag from our mapping
                String flag = countryCodeToEmoji[countryCode] ?? 'ğŸ³ï¸';
                
                countries.add({
                  'name': name,
                  'code': countryCode,
                  'flag': flag,
                });
                
                // Break after first valid suffix to avoid duplicates
                break;
              }
            }
          }
        }
        
        // Sort by country name
        countries.sort((a, b) => a['name']!.compareTo(b['name']!));
        
        // Move common countries to top
        final commonCountries = ['India', 'United States', 'United Kingdom', 'Canada', 'Australia'];
        countries.sort((a, b) {
          final aIndex = commonCountries.indexOf(a['name']!);
          final bIndex = commonCountries.indexOf(b['name']!);
          
          if (aIndex != -1 && bIndex != -1) return aIndex.compareTo(bIndex);
          if (aIndex != -1) return -1;
          if (bIndex != -1) return 1;
          return a['name']!.compareTo(b['name']!);
        });
        
        return countries;
      }
    } catch (e) {
      print('Error fetching countries: $e');
    }
    
    // Fallback to hardcoded list if API fails
    return getFallbackCountries();
  }
  
  static List<Map<String, String>> getFallbackCountries() {
    return [
      {'name': 'India', 'code': '+91', 'flag': 'ğŸ‡®ğŸ‡³'},
      {'name': 'United States', 'code': '+1', 'flag': 'ğŸ‡ºğŸ‡¸'},
      {'name': 'United Kingdom', 'code': '+44', 'flag': 'ğŸ‡¬ğŸ‡§'},
      {'name': 'Canada', 'code': '+1', 'flag': 'ğŸ‡¨ğŸ‡¦'},
      {'name': 'Australia', 'code': '+61', 'flag': 'ğŸ‡¦ğŸ‡º'},
      {'name': 'Germany', 'code': '+49', 'flag': 'ğŸ‡©ğŸ‡ª'},
      {'name': 'France', 'code': '+33', 'flag': 'ğŸ‡«ğŸ‡·'},
      {'name': 'Japan', 'code': '+81', 'flag': 'ğŸ‡¯ğŸ‡µ'},
      {'name': 'China', 'code': '+86', 'flag': 'ğŸ‡¨ğŸ‡³'},
      {'name': 'Russia', 'code': '+7', 'flag': 'ğŸ‡·ğŸ‡º'},
      {'name': 'Brazil', 'code': '+55', 'flag': 'ğŸ‡§ğŸ‡·'},
      {'name': 'Mexico', 'code': '+52', 'flag': 'ğŸ‡²ğŸ‡½'},
      {'name': 'South Korea', 'code': '+82', 'flag': 'ğŸ‡°ğŸ‡·'},
      {'name': 'Italy', 'code': '+39', 'flag': 'ğŸ‡®ğŸ‡¹'},
      {'name': 'Spain', 'code': '+34', 'flag': 'ğŸ‡ªğŸ‡¸'},
    ];
  }
}